# Integration Contract Baseline

**Status**: Captured on 2025-10-23
**Purpose**: Document current integration state between web app and trodes_to_nwb Python package

## Summary

This document captures the baseline integration contract state between:
- **rec_to_nwb_yaml_creator** (this web app)
- **trodes_to_nwb** (Python package)

## Critical Findings

### 1. Schema Mismatch (P0 Bug)

**Status**: ❌ SCHEMAS OUT OF SYNC

```
Web App Schema Hash:  49df05392d08b5d0...
trodes_to_nwb Hash:   6ef519f598ae930e...
```

**Impact**:
- YAML files generated by web app may fail validation in Python package
- Data conversion failures
- Pipeline breakage

**Action Required**: Investigate schema differences and synchronize

### 2. Missing Device Types

**Status**: ⚠️ 4 device types missing from web app

**Missing from Web App** (exist in trodes_to_nwb):
- `128c-4s4mm6cm-15um-26um-sl`
- `128c-4s4mm6cm-20um-40um-sl`
- `128c-4s6mm6cm-20um-40um-sl` (Note: similar to existing 128c-4s6mm6cm-20um-40um-sl)
- `128c-4s8mm6cm-15um-26um-sl`

**Missing Probe Files** (in web app but no probe metadata):
- None ✅

**Impact**:
- Users cannot select 4mm variants of 128-channel probes
- May cause confusion if users have 4mm probes
- No data corruption risk (all web app types have probe files)

### 3. Field Name Compatibility

**Status**: ✅ Documented

The schema uses `experimenter_name` (not `experimenter`). This is the correct field name for the integration contract.

**Required Fields** (documented):
```json
[
  "experimenter_name",
  "lab",
  "institution",
  "data_acq_device",
  "times_period_multiplier",
  "raw_data_to_volts"
]
```

## Integration Points

### 1. Schema Synchronization

**Contract**: `nwb_schema.json` must be identical in both repositories

**Current State**: OUT OF SYNC ❌

**Verification**: SHA-256 hash comparison
- CI check: `.github/workflows/test.yml` (integration job)
- Unit test: `src/__tests__/integration/schema-contracts.test.js`

**Resolution**:
- Determine authoritative schema source
- Synchronize schemas
- Add git hooks or CI checks to prevent drift

### 2. Device Type Resolution

**Contract**: Every `device_type` in `deviceTypes()` must have corresponding file in `trodes_to_nwb/src/trodes_to_nwb/device_metadata/probe_metadata/{device_type}.yml`

**Current State**: ✅ All web app device types have probe files

**Web App Device Types** (8):
1. tetrode_12.5
2. A1x32-6mm-50-177-H32_21mm
3. 128c-4s8mm6cm-20um-40um-sl
4. 128c-4s6mm6cm-15um-26um-sl
5. 32c-2s8mm6cm-20um-40um-dl
6. 64c-4s6mm6cm-20um-40um-dl
7. 64c-3s6mm6cm-20um-40um-sl
8. NET-EBL-128ch-single-shank

**trodes_to_nwb Probe Files** (12):
- All 8 web app types ✅
- Plus 4 additional 4mm variants

### 3. Field Name Compatibility

**Contract**: Generated YAML field names must match Python package expectations

**Known Discrepancies**:
- Schema uses `experimenter_name` (array)
- Some documentation refers to `experimenter` (incorrect)

**Verification Needed**:
- Check if Python package expects `experimenter` or `experimenter_name`
- Verify field name consistency across:
  - nwb_schema.json
  - Python validation code
  - Spyglass database schema

### 4. YAML Generation Format

**Contract**: Generated YAML must be parseable and valid according to schema

**Current State**: ✅ Generation works (documented in fixtures)

**Test Fixtures**:
- `src/__tests__/fixtures/valid/minimal-valid.yml`
- `src/__tests__/fixtures/valid/complete-valid.yml`
- `src/__tests__/fixtures/valid/realistic-session.yml`

## Test Coverage

### Unit Tests

**File**: `src/__tests__/integration/schema-contracts.test.js`

**Tests** (7):
1. ✅ Documents current schema version (hash)
2. ✅ Verifies schema sync with trodes_to_nwb (if available)
3. ✅ Documents all supported device types
4. ✅ All device types are non-empty strings
5. ✅ Verifies device types exist in trodes_to_nwb (if available)
6. ✅ Documents YAML output format
7. ✅ Schema contains critical metadata fields

### CI Tests

**File**: `.github/workflows/test.yml`

**Integration Job**:
- Checks out both repositories
- Compares schema hashes
- Fails if schemas don't match

## Recommended Actions

### Immediate (Phase 1)

1. **Investigate schema mismatch**
   - Compare schemas side-by-side
   - Determine which is authoritative
   - Document differences

2. **Verify field name usage**
   - Check Python code for `experimenter` vs `experimenter_name`
   - Check Spyglass ingestion code
   - Update documentation if needed

### Short-term (Phase 2)

3. **Add missing device types**
   - Add 4mm variants to `valueList.js`
   - Add to `deviceTypes.js` mapping
   - Test generation with new types

4. **Synchronize schemas**
   - Copy authoritative schema to both repos
   - Add pre-commit hook to prevent drift
   - Document schema update process

### Long-term (Phase 3)

5. **Improve integration testing**
   - Add E2E test: generate YAML → validate with Python
   - Add test: generate YAML → convert to NWB → validate
   - Add test: NWB → ingest to Spyglass → verify

6. **Schema governance**
   - Single source of truth for schema
   - Version schema explicitly
   - Automated sync or shared submodule

## Snapshot Reference

All baselines captured in:
```
src/__tests__/integration/__snapshots__/schema-contracts.test.js.snap
```

**Schema Hash**: `49df05392d08b5d01c8b5706d29887715109f6689c1d1225f7279dd4d62391d3`

**Device Types Snapshot**: 8 types documented

**Sync Status Snapshot**: Schemas OUT OF SYNC

## Notes

- These tests gracefully degrade if trodes_to_nwb is not available (useful for CI)
- Snapshots document CURRENT state, including bugs
- Fixing bugs will require updating snapshots
- Schema mismatch is documented as baseline but is a CRITICAL bug to fix
