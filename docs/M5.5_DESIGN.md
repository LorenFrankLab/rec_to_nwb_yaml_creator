# M5.5 Animal Creation Form - Design Document

**Status:** DESIGN_APPROVED
**Date:** 2025-10-28
**Version:** 2.0 (incorporating code review, UI review, UX review)

---

## Executive Summary

This milestone fills a **critical gap** in the workspace UI: users currently cannot create animals through the interface. The design follows M5 patterns (Container/Presentational, Material Design, TDD) and focuses on **minimal required fields** with smart defaults to enable fast (<1 minute) animal creation.

**Key Features:**

- Minimal 8-field form (subject info + experimenters)
- Smart defaults from workspace settings/last animal
- Controlled inputs with field-level validation
- Species dropdown (constrained vocabulary)
- Dynamic experimenter list (add/remove)
- HTML5 date picker with constraints
- WCAG 2.1 Level AA accessibility
- Success navigation to AnimalWorkspace

---

## Design Rationale

### Progressive Disclosure Philosophy

**Problem:** Original form has 100+ fields across devices, cameras, tasks, optogenetics. Showing all upfront overwhelms users.

**Solution:** Collect only what's known at "animal creation time":

1. **Animal creation (this milestone):** Subject info + experimenters (8 fields)
2. **Day creation (M4 existing):** Add recording session with auto-generated ID
3. **Day editing (M5 existing):** Configure hardware in Devices step per session

**Rationale:**

- Matches scientific workflow: know subject → schedule session → configure hardware
- Cognitive load management: 8 fields vs. 50+ fields
- Enables probe reconfiguration across days (M10)
- Fast time-to-value: <1 minute to create animal + first day

---

## Component Architecture

### File Structure

```
src/pages/Home/
  ├── index.jsx                      (update - replace stub)
  ├── AnimalCreationForm.jsx         (new - presentational form)
  ├── Home.css                        (new - styling)
  └── __tests__/
      ├── Home.test.jsx               (new - 5 tests)
      └── AnimalCreationForm.test.jsx (new - 15 tests)
```

### Pattern: Container/Presentational

**Home.jsx (Container):**

- Manages store integration via `useStoreContext()`
- Fetches default experimenters from workspace settings/last animal
- Handles navigation after creation
- Error handling and user feedback

**AnimalCreationForm.jsx (Presentational):**

- Pure form component with callbacks
- Controlled inputs with local state
- Field-level validation
- ARIA attributes and accessibility

**Matches M5 pattern:** DayEditorStepper (container) → OverviewStep (presentational)

---

## Data Structure & Store Integration

### Form State

```javascript
// Controlled inputs - state managed in AnimalCreationForm
const [formData, setFormData] = useState({
  // Subject section
  subject_id: '',
  species: 'Rattus norvegicus', // Default
  sex: 'U',                      // Default to Unknown
  genotype: '',
  date_of_birth: '',
  description: '',

  // Experimenters section (pre-filled from defaults)
  experimenter_names: [''],      // Dynamic list
  lab: '',
  institution: '',
});
```

### Store API Integration

**CRITICAL FIX** (from code review P0-1): Match `createAnimal()` signature in store.js:160

```javascript
// store.js signature:
// createAnimal(animalId, subject, metadata)

const handleSubmit = async () => {
  // Validate
  const { valid, errors } = validateAnimalForm(
    formData,
    model.workspace.animals
  );
  if (!valid) {
    setFieldErrors(errors);
    return;
  }

  const animalId = formData.subject_id.toLowerCase().trim();

  // Build subject object (matches NWB schema)
  const subject = {
    subject_id: animalId,
    species: formData.species,
    sex: formData.sex,
    genotype: formData.genotype,
    date_of_birth: formData.date_of_birth,
    description: formData.description || '',
  };

  // Build metadata object
  const metadata = {
    experimenters: {
      experimenter_name: formData.experimenter_names.filter(n => n.trim()),
      lab: formData.lab,
      institution: formData.institution,
    },
    // Devices auto-created empty (configured later in Day Editor)
    devices: {
      data_acq_device: [],
      device: { name: [] },
      electrode_groups: [],
      ntrode_electrode_group_channel_map: []
    },
    cameras: [],
  };

  try {
    // Call store action with correct signature
    actions.createAnimal(animalId, subject, metadata);

    // Navigate after state update completes
    setTimeout(() => {
      window.location.hash = `#/workspace?animal=${animalId}`;
    }, 0);
  } catch (error) {
    console.error('Failed to create animal:', error);

    // Categorize errors
    if (error.message.includes('already exists')) {
      setFieldErrors({
        subject_id: `Animal "${animalId}" already exists`
      });
    } else if (error.message.includes('localStorage')) {
      setSubmitError('Storage quota exceeded. Please export existing animals.');
    } else {
      setSubmitError(`Failed to create animal: ${error.message}`);
    }
  }
};
```

---

## Form Fields (Detailed Specification)

### 1. Subject ID

**Type:** Text input
**Label:** "Subject ID *"
**Required:** Yes
**Autofocus:** Yes

**Validation:**

- Required
- No whitespace (trim before submit)
- Must be unique in `workspace.animals`
- Pattern: `/^[a-zA-Z0-9_-]+$/` (alphanumeric + underscore/hyphen)

**Validation timing:**

- On blur: Check uniqueness
- On submit: Re-check for race conditions

**Error messages:**

- Empty: "Subject ID is required"
- Whitespace: "Subject ID cannot contain spaces"
- Invalid chars: "Use only letters, numbers, underscores, and hyphens"
- Duplicate: "Animal '{id}' already exists"

**UI:**

```jsx
<div className="form-field">
  <label htmlFor="subject-id" className="required">
    Subject ID
  </label>
  <input
    id="subject-id"
    type="text"
    value={formData.subject_id}
    onChange={(e) => handleChange('subject_id', e.target.value)}
    onBlur={() => handleBlur('subject_id')}
    required
    autoFocus
    placeholder="e.g., remy, bean"
    aria-describedby={errors.subject_id ? 'subject-id-error' : 'subject-id-hint'}
    aria-invalid={!!errors.subject_id}
    className={errors.subject_id ? 'invalid' : ''}
  />
  <span id="subject-id-hint" className="validation-hint">
    Unique identifier for this animal (letters, numbers, - or _)
  </span>
  {errors.subject_id && (
    <span id="subject-id-error" className="validation-error" role="alert">
      {errors.subject_id}
    </span>
  )}
  {showExistingAnimalLink && (
    <a href={`#/workspace?animal=${formData.subject_id}`}>
      View existing animal '{formData.subject_id}' →
    </a>
  )}
</div>
```

---

### 2. Species

**Type:** Dropdown (select) with "Other" option
**Label:** "Species *"
**Required:** Yes
**Default:** "Rattus norvegicus"

**Options:**

- Rattus norvegicus (Rat)
- Mus musculus (Mouse)
- Callithrix jacchus (Marmoset)
- Macaca mulatta (Rhesus macaque)
- Other (specify)

**Validation:**

- Required
- If "Other": custom text field becomes required

**Rationale (from UX review P0-4):**

- Prevents database pollution (no "rat" vs "Rat" vs "RAT")
- Enforces scientific names for NWB compatibility
- 95% of Frank Lab covered by dropdown
- "Other" escape hatch for rare species

**UI:**

```jsx
<div className="form-field">
  <label htmlFor="species" className="required">
    Species
  </label>
  <select
    id="species"
    value={formData.species}
    onChange={(e) => {
      handleChange('species', e.target.value);
      setShowCustomSpecies(e.target.value === 'other');
    }}
    required
    aria-describedby="species-hint"
  >
    <option value="Rattus norvegicus">Rat (Rattus norvegicus)</option>
    <option value="Mus musculus">Mouse (Mus musculus)</option>
    <option value="Callithrix jacchus">Marmoset (Callithrix jacchus)</option>
    <option value="Macaca mulatta">Rhesus macaque (Macaca mulatta)</option>
    <option value="other">Other (specify)...</option>
  </select>
  <span id="species-hint" className="validation-hint">
    Biological species of the subject
  </span>

  {showCustomSpecies && (
    <>
      <label htmlFor="species-custom" className="required">
        Custom Species
      </label>
      <input
        id="species-custom"
        type="text"
        value={formData.speciesCustom}
        onChange={(e) => handleChange('speciesCustom', e.target.value)}
        required
        placeholder="Enter scientific name (e.g., Homo sapiens)"
        aria-describedby="species-custom-hint"
      />
      <span id="species-custom-hint" className="validation-hint">
        Use scientific name (genus species) for NWB compatibility
      </span>
    </>
  )}
</div>
```

---

### 3. Sex

**Type:** Radio buttons (horizontal layout)
**Label:** "Sex *"
**Required:** Yes
**Default:** "U" (Unknown)

**Options:**

- M (Male)
- F (Female)
- U (Unknown)
- O (Other)

**Validation:**

- Required (one must be selected)

**UI:**

```jsx
<fieldset className="form-field">
  <legend className="required">Sex</legend>
  <div className="radio-group">
    {[
      { value: 'M', label: 'Male (M)' },
      { value: 'F', label: 'Female (F)' },
      { value: 'U', label: 'Unknown (U)' },
      { value: 'O', label: 'Other (O)' },
    ].map(({ value, label }) => (
      <label key={value} className="radio-label">
        <input
          type="radio"
          name="sex"
          value={value}
          checked={formData.sex === value}
          onChange={(e) => handleChange('sex', e.target.value)}
          required
        />
        {label}
      </label>
    ))}
  </div>
</fieldset>
```

**CSS (from UI review P1.2):**

```css
.radio-group {
  display: flex;
  gap: var(--spacing-md);
  flex-wrap: wrap;
}

.radio-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  cursor: pointer;
}

.radio-label input[type="radio"] {
  cursor: pointer;
}
```

---

### 4. Genotype

**Type:** Text input with placeholder
**Label:** "Genotype *"
**Required:** Yes

**Validation:**

- Required
- Free text (no format constraint)

**Guidance (from UX review P1-1):**

```jsx
<div className="form-field">
  <label htmlFor="genotype" className="required">
    Genotype
  </label>
  <input
    id="genotype"
    type="text"
    value={formData.genotype}
    onChange={(e) => handleChange('genotype', e.target.value)}
    required
    placeholder="e.g., Wild-type, Thy1-ChR2-YFP"
    aria-describedby="genotype-hint"
  />
  <span id="genotype-hint" className="validation-hint">
    Genetic background or transgene expression. Use "Wild-type" for unmodified animals.
  </span>
</div>
```

---

### 5. Date of Birth

**Type:** HTML5 date input
**Label:** "Date of Birth *"
**Required:** Yes

**Validation:**

- Required
- Cannot be in future (constraint via `max` attribute)
- Warning if >5 years ago (non-blocking)

**Implementation (from UX review P0-2):**

```jsx
const today = new Date().toISOString().split('T')[0];
const fiveYearsAgo = new Date();
fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
const minDate = fiveYearsAgo.toISOString().split('T')[0];

<div className="form-field">
  <label htmlFor="date-of-birth" className="required">
    Date of Birth
  </label>
  <input
    id="date-of-birth"
    type="date"
    value={formData.date_of_birth}
    onChange={(e) => handleChange('date_of_birth', e.target.value)}
    onBlur={() => validateDateOfBirth()}
    max={today}
    required
    aria-describedby="dob-hint"
  />
  <span id="dob-hint" className="validation-hint">
    Subject's date of birth. Must not be in the future.
  </span>
  {ageWarning && (
    <div className="validation-warning" role="status">
      ⚠ Subject would be {ageYears} years old. Verify date is correct.
    </div>
  )}
</div>
```

**Validation logic:**

```javascript
const validateDateOfBirth = () => {
  const date = new Date(formData.date_of_birth);
  const today = new Date();

  if (date > today) {
    setFieldErrors(prev => ({
      ...prev,
      date_of_birth: "Date of birth cannot be in the future"
    }));
    return false;
  }

  // Non-blocking warning for old dates
  const age = (today - date) / (1000 * 60 * 60 * 24 * 365.25);
  if (age > 5) {
    setAgeWarning(`Subject would be ${Math.round(age)} years old.`);
  } else {
    setAgeWarning(null);
  }

  return true;
};
```

---

### 6. Experimenter Names

**Type:** Dynamic list (add/remove)
**Label:** "Experimenter Names *"
**Required:** At least one name

**Rationale (from UX review P0-1):**

- Dynamic list avoids format ambiguity (no comma parsing issues)
- Per-name validation and error feedback
- Matches complex array patterns elsewhere (electrode groups)
- Clear UX: explicit add/remove buttons

**UI:**

```jsx
<div className="form-field">
  <label id="experimenter-label" className="required">
    Experimenter Names
  </label>
  <div role="group" aria-labelledby="experimenter-label">
    {formData.experimenter_names.map((name, idx) => (
      <div key={idx} className="list-item">
        <input
          id={`experimenter-${idx}`}
          type="text"
          value={name}
          onChange={(e) => updateExperimenterName(idx, e.target.value)}
          required={idx === 0}
          placeholder="Firstname Lastname"
          aria-label={`Experimenter ${idx + 1}`}
          aria-describedby={errors[`experimenter_${idx}`] ? `exp-error-${idx}` : null}
        />
        {idx > 0 && (
          <button
            type="button"
            onClick={() => removeExperimenter(idx)}
            aria-label={`Remove experimenter ${idx + 1}`}
          >
            Remove
          </button>
        )}
        {errors[`experimenter_${idx}`] && (
          <span id={`exp-error-${idx}`} className="validation-error" role="alert">
            {errors[`experimenter_${idx}`]}
          </span>
        )}
      </div>
    ))}
    <button
      type="button"
      onClick={addExperimenter}
      className="add-item-button"
    >
      + Add Experimenter
    </button>
  </div>
  <span className="validation-hint">
    At least one experimenter is required
  </span>
</div>
```

**State management:**

```javascript
const addExperimenter = () => {
  setFormData(prev => ({
    ...prev,
    experimenter_names: [...prev.experimenter_names, '']
  }));
};

const removeExperimenter = (idx) => {
  setFormData(prev => ({
    ...prev,
    experimenter_names: prev.experimenter_names.filter((_, i) => i !== idx)
  }));
};

const updateExperimenterName = (idx, value) => {
  setFormData(prev => ({
    ...prev,
    experimenter_names: prev.experimenter_names.map((name, i) =>
      i === idx ? value : name
    )
  }));
};
```

---

### 7. Lab

**Type:** Text input
**Label:** "Lab *"
**Required:** Yes
**Default:** From workspace settings or last animal

**Validation:**

- Required
- Cannot be only whitespace

---

### 8. Institution

**Type:** Text input
**Label:** "Institution *"
**Required:** Yes
**Default:** From workspace settings or last animal

**Validation:**

- Required
- Cannot be only whitespace

---

## Smart Defaults Strategy

**Precedence (from UX review P1-3):**

```javascript
// In Home.jsx
const getDefaultExperimenters = () => {
  const { settings, animals } = model.workspace;

  // Priority 1: Workspace settings (if non-empty)
  if (settings?.default_lab?.trim()) {
    return {
      experimenter_names: settings.default_experimenters || [''],
      lab: settings.default_lab,
      institution: settings.default_institution,
    };
  }

  // Priority 2: Most recent animal's experimenters
  const animalIds = Object.keys(animals).sort();
  if (animalIds.length > 0) {
    const lastAnimal = animals[animalIds[animalIds.length - 1]];
    return {
      experimenter_names: lastAnimal.experimenters.experimenter_name,
      lab: lastAnimal.experimenters.lab,
      institution: lastAnimal.experimenters.institution,
    };
  }

  // Priority 3: Hardcoded Frank Lab defaults
  return {
    experimenter_names: [''],
    lab: 'Loren Frank Lab',
    institution: 'University of California, San Francisco',
  };
};
```

---

## Validation Strategy

### Client-Side Validation

**Create custom validator** (from code review P0-2):

```javascript
// In AnimalCreationForm.jsx or separate validation.js

/**
 * Validate animal creation form
 * @param {object} formData - Form data to validate
 * @param {object} existingAnimals - workspace.animals for uniqueness check
 * @returns {{ valid: boolean, errors: object }}
 */
export function validateAnimalForm(formData, existingAnimals) {
  const errors = {};

  // Subject ID
  if (!formData.subject_id?.trim()) {
    errors.subject_id = 'Subject ID is required';
  } else if (/\s/.test(formData.subject_id)) {
    errors.subject_id = 'Subject ID cannot contain spaces';
  } else if (!/^[a-zA-Z0-9_-]+$/.test(formData.subject_id)) {
    errors.subject_id = 'Use only letters, numbers, underscores, and hyphens';
  } else {
    const normalized = formData.subject_id.toLowerCase().trim();
    if (Object.keys(existingAnimals).includes(normalized)) {
      errors.subject_id = `Animal "${formData.subject_id}" already exists`;
    }
  }

  // Species
  if (!formData.species?.trim()) {
    errors.species = 'Species is required';
  }
  if (formData.species === 'other' && !formData.speciesCustom?.trim()) {
    errors.speciesCustom = 'Custom species name is required';
  }

  // Sex
  if (!formData.sex) {
    errors.sex = 'Sex is required';
  }

  // Genotype
  if (!formData.genotype?.trim()) {
    errors.genotype = 'Genotype is required';
  }

  // Date of birth
  if (!formData.date_of_birth) {
    errors.date_of_birth = 'Date of birth is required';
  } else {
    const dob = new Date(formData.date_of_birth);
    const today = new Date();
    if (dob > today) {
      errors.date_of_birth = 'Date of birth cannot be in the future';
    }
  }

  // Experimenter names
  const validNames = formData.experimenter_names.filter(n => n.trim());
  if (validNames.length === 0) {
    errors.experimenter_names = 'At least one experimenter is required';
  }

  // Lab
  if (!formData.lab?.trim()) {
    errors.lab = 'Lab is required';
  }

  // Institution
  if (!formData.institution?.trim()) {
    errors.institution = 'Institution is required';
  }

  return {
    valid: Object.keys(errors).length === 0,
    errors,
  };
}
```

### Field-Level Validation (On Blur)

```javascript
const handleBlur = async (fieldName) => {
  // Validate single field
  const { errors } = validateAnimalForm(formData, model.workspace.animals);

  if (errors[fieldName]) {
    setFieldErrors(prev => ({ ...prev, [fieldName]: errors[fieldName] }));
  } else {
    // Clear error when field becomes valid
    setFieldErrors(prev => {
      const newErrors = { ...prev };
      delete newErrors[fieldName];
      return newErrors;
    });
  }
};
```

### Submit Validation

```javascript
const handleSubmit = async (e) => {
  e.preventDefault();

  // Full form validation
  const { valid, errors } = validateAnimalForm(
    formData,
    model.workspace.animals
  );

  if (!valid) {
    setFieldErrors(errors);
    // Focus first error field
    const firstErrorField = Object.keys(errors)[0];
    document.getElementById(firstErrorField)?.focus();
    return;
  }

  // Proceed with creation...
};
```

---

## Styling & CSS

### CSS Architecture (from UI review P1-4)

**Create Home.css that imports DayEditor variables:**

```css
/* Home.css */

/* Import M5 CSS variables */
@import '../DayEditor/DayEditor.css';

/* Page container - centered form card */
.animal-creation-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 80px); /* Account for header */
  background-color: var(--color-grey-100);
  padding: var(--spacing-lg);
}

/* Form card */
.animal-creation-form {
  background-color: var(--color-white);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  padding: var(--spacing-xl);
  max-width: 700px;
  width: 100%;
}

.animal-creation-form h1 {
  margin-top: 0;
  margin-bottom: var(--spacing-lg);
  font-size: var(--font-size-xl);
  text-align: center;
  color: var(--color-grey-900);
}

/* Form sections - reuse M5 pattern */
.form-section {
  background-color: var(--color-white);
  border: 1px solid var(--color-grey-200);
  border-radius: 4px;
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
}

.form-section h2 {
  margin-top: 0;
  margin-bottom: var(--spacing-md);
  font-size: var(--font-size-lg);
  color: var(--color-grey-800);
}

/* Radio buttons (new) */
.radio-group {
  display: flex;
  gap: var(--spacing-md);
  flex-wrap: wrap;
}

.radio-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  cursor: pointer;
  font-size: var(--font-size-base);
}

.radio-label input[type="radio"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}

/* Dynamic list items */
.list-item {
  display: flex;
  gap: var(--spacing-sm);
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
}

.list-item input {
  flex: 1;
}

.list-item button {
  flex-shrink: 0;
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: var(--color-grey-200);
  border: 1px solid var(--color-grey-300);
  border-radius: 4px;
  cursor: pointer;
  font-size: var(--font-size-sm);
}

.list-item button:hover {
  background-color: var(--color-grey-300);
}

.add-item-button {
  margin-top: var(--spacing-xs);
  padding: var(--spacing-sm) var(--spacing-md);
  background-color: var(--color-primary-light);
  border: 1px solid var(--color-primary);
  color: var(--color-primary);
  border-radius: 4px;
  cursor: pointer;
  font-size: var(--font-size-sm);
  font-weight: 500;
}

.add-item-button:hover {
  background-color: var(--color-primary);
  color: var(--color-white);
}

/* Form actions */
.form-actions {
  display: flex;
  gap: var(--spacing-md);
  justify-content: flex-end;
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--color-grey-200);
}

.btn-primary {
  padding: var(--spacing-sm) var(--spacing-lg);
  background-color: var(--color-primary);
  color: var(--color-white);
  border: none;
  border-radius: 4px;
  font-size: var(--font-size-base);
  font-weight: 500;
  cursor: pointer;
  transition: background-color var(--transition-fast);
}

.btn-primary:hover:not(:disabled) {
  background-color: var(--color-primary-hover);
}

.btn-primary:disabled {
  background-color: var(--color-grey-300);
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-secondary {
  padding: var(--spacing-sm) var(--spacing-lg);
  background-color: transparent;
  color: var(--color-grey-700);
  border: 1px solid var(--color-grey-300);
  border-radius: 4px;
  font-size: var(--font-size-base);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.btn-secondary:hover {
  background-color: var(--color-grey-100);
  border-color: var(--color-grey-400);
}

/* Validation summary */
.validation-summary {
  background-color: var(--color-error-light);
  border: 1px solid var(--color-error);
  border-radius: 4px;
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.validation-summary strong {
  color: var(--color-error);
  display: block;
  margin-bottom: var(--spacing-xs);
}

.validation-summary ul {
  margin: 0;
  padding-left: var(--spacing-lg);
}

.validation-summary a {
  color: var(--color-error);
  text-decoration: underline;
}

/* Warning messages */
.validation-warning {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-xs);
  padding: var(--spacing-sm);
  background-color: var(--color-warning-light);
  border: 1px solid var(--color-warning);
  border-radius: 4px;
  color: var(--color-warning);
  font-size: var(--font-size-sm);
}

/* First-time user notice */
.first-time-user-notice {
  background-color: var(--color-primary-light);
  border: 1px solid var(--color-primary);
  border-radius: 4px;
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.first-time-user-notice p {
  margin: var(--spacing-xs) 0;
  color: var(--color-grey-800);
}

/* Responsive */
@media (max-width: 768px) {
  .animal-creation-form {
    padding: var(--spacing-lg);
  }

  .form-actions {
    flex-direction: column-reverse;
  }

  .form-actions button,
  .form-actions a {
    width: 100%;
    text-align: center;
  }

  .radio-group {
    flex-direction: column;
  }
}
```

---

## User Flow

### Success Path

1. User navigates to `#/home`
2. Form appears with subject_id field focused
3. User fills 8 required fields (experimenters pre-filled)
4. Fields validate on blur with inline errors
5. Submit button enabled when all valid
6. User clicks "Create Animal"
7. Success: Navigate to `#/workspace?animal={id}`
8. New animal visible in AnimalWorkspace sidebar
9. User clicks "Add Recording Day" to continue

### First-Time User Experience (from UX review P0-3)

```jsx
// In Home.jsx
{Object.keys(model.workspace.animals).length === 0 && (
  <div className="first-time-user-notice" role="note">
    <p><strong>Welcome!</strong> To get started, create your first animal subject.</p>
    <p>
      Need help? <a href="#/docs/getting-started">Read Getting Started Guide</a>
    </p>
  </div>
)}
```

### Cancel Behavior

```jsx
<button
  type="button"
  onClick={handleCancel}
  className="btn-secondary"
>
  {Object.keys(model.workspace.animals).length > 0
    ? 'Cancel'
    : 'Skip for Now'}
</button>
```

```javascript
const handleCancel = () => {
  if (Object.keys(model.workspace.animals).length > 0) {
    // Animals exist - go to workspace
    window.location.hash = '#/workspace';
  } else {
    // No animals - link to documentation
    window.location.hash = '#/docs/getting-started';
  }
};
```

---

## Accessibility (WCAG 2.1 Level AA)

### Form Semantics

- ✅ `<form>` element with `onSubmit` handler
- ✅ All inputs have associated `<label>` with `htmlFor`
- ✅ Required fields marked with `aria-required="true"` and `.required` class
- ✅ Invalid fields marked with `aria-invalid="true"`
- ✅ Error messages linked via `aria-describedby`
- ✅ Fieldset with legend for radio button group
- ✅ Dynamic list has `role="group"` with `aria-labelledby`

### Keyboard Navigation

- ✅ Tab order: fields in logical sequence
- ✅ Enter key submits form
- ✅ Escape key cancels (if modal, otherwise navigates away)
- ✅ First error field gets focus after failed validation

```javascript
// Keyboard shortcuts
useEffect(() => {
  const handleKeyDown = (e) => {
    // Escape to cancel
    if (e.key === 'Escape') {
      handleCancel();
    }
    // Ctrl+Enter to submit (when valid)
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && isValid) {
      handleSubmit(e);
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [isValid]);
```

### Screen Reader Announcements

```jsx
{/* Validation summary announced on submit */}
{!isValid && Object.keys(fieldErrors).length > 0 && (
  <div
    id="validation-summary"
    role="alert"
    aria-live="assertive"
    className="validation-summary"
  >
    <strong>Please fix the following errors:</strong>
    <ul>
      {Object.entries(fieldErrors).map(([field, error]) => (
        <li key={field}>
          <a href={`#${field}`}>
            {fieldLabels[field]}: {error}
          </a>
        </li>
      ))}
    </ul>
  </div>
)}
```

### Color Contrast

- ✅ Error text: #d32f2f on white = 6.58:1 (AA pass)
- ✅ Warning text: #d84315 on #fff3e0 = 4.7:1 (AA pass, fixed from M5)
- ✅ Helper text: #666 on white = 5.74:1 (AA pass)
- ✅ Primary button: white on #2196f3 = 5.38:1 (AA pass)

---

## Testing Strategy (TDD)

### Test Coverage Target: 85%+

### Home.test.jsx (5 tests)

```javascript
describe('Home - Animal Creation Container', () => {
  it('renders AnimalCreationForm component', () => {
    // Verify form is rendered
  });

  it('passes default experimenters from workspace settings', () => {
    // Mock workspace.settings with defaults
    // Verify form receives correct props
  });

  it('navigates to AnimalWorkspace after successful creation', () => {
    // Mock successful createAnimal
    // Verify hash changes to #/workspace?animal={id}
  });

  it('shows error message when creation fails', () => {
    // Mock createAnimal throwing error
    // Verify error message displayed
  });

  it('has proper WCAG landmarks and heading', () => {
    // Verify main landmark, h1, form element
  });
});
```

### AnimalCreationForm.test.jsx (15 tests)

```javascript
describe('AnimalCreationForm', () => {
  // Rendering
  it('renders all 8 required fields', () => {
    // subject_id, species, sex, genotype, date_of_birth
    // experimenter_names, lab, institution
  });

  it('pre-fills experimenters from defaultExperimenters prop', () => {
    // Verify lab, institution, names pre-filled
  });

  // Validation
  it('validates subject_id uniqueness on blur', () => {
    // Enter duplicate ID -> see error
  });

  it('validates date_of_birth not in future', () => {
    // Enter future date -> see error
  });

  it('shows warning for date_of_birth >5 years ago', () => {
    // Enter old date -> see warning (not error)
  });

  it('validates at least one experimenter name required', () => {
    // Remove all names -> see error
  });

  it('validates species required when "Other" selected', () => {
    // Select "Other" without custom value -> error
  });

  // Submit behavior
  it('disables submit button when form invalid', () => {
    // Empty form -> button disabled
  });

  it('enables submit button when all required fields valid', () => {
    // Fill valid data -> button enabled
  });

  it('calls onSubmit with correct data structure', () => {
    // Submit -> verify data passed to callback
  });

  it('prevents duplicate submission (race condition)', () => {
    // Submit -> animal created by another user mid-flight
    // -> shows error, doesn't create duplicate
  });

  // Interactions
  it('adds experimenter when "Add Experimenter" clicked', () => {
    // Click add -> new input appears
  });

  it('removes experimenter when "Remove" clicked', () => {
    // Add 2 experimenters, remove one -> only 1 remains
  });

  // Accessibility
  it('focuses first error field after failed validation', () => {
    // Submit invalid -> check focus moved
  });

  it('announces validation errors to screen readers', () => {
    // Submit invalid -> check aria-live region updated
  });
});
```

### Edge Cases to Test

```javascript
describe('AnimalCreationForm - Edge Cases', () => {
  it('trims subject_id spaces before validation', () => {
    // Input: "  remy  " -> validates as "remy"
  });

  it('handles empty string in experimenter names array', () => {
    // ["Alice", "", "Bob"] -> filters to ["Alice", "Bob"]
  });

  it('converts species "other" + custom to final species value', () => {
    // species="other", speciesCustom="Homo sapiens"
    // -> submits species="Homo sapiens"
  });

  it('shows appropriate cancel button text for first-time users', () => {
    // No animals -> "Skip for Now"
    // Animals exist -> "Cancel"
  });
});
```

---

## Implementation Checklist

### Phase 1: Setup & Tests (TDD)

- [ ] Create `Home.css` with imports from DayEditor.css
- [ ] Create test files: `Home.test.jsx`, `AnimalCreationForm.test.jsx`
- [ ] Write failing tests (15 tests for form, 5 for container)
- [ ] Run tests, verify all fail

### Phase 2: Form Component

- [ ] Create `AnimalCreationForm.jsx` with controlled inputs
- [ ] Implement all 8 fields with validation
- [ ] Add dynamic experimenter list (add/remove)
- [ ] Add species dropdown with "Other" option
- [ ] Add HTML5 date input with constraints
- [ ] Add radio buttons for sex
- [ ] Add form actions (submit, cancel)
- [ ] Run tests, verify 15 tests pass

### Phase 3: Container Integration

- [ ] Update `Home/index.jsx` to use AnimalCreationForm
- [ ] Implement `getDefaultExperimenters()` helper
- [ ] Implement `handleSubmit()` with store integration
- [ ] Implement `handleCancel()` with conditional navigation
- [ ] Add error handling with categorization
- [ ] Add first-time user notice
- [ ] Run tests, verify 20 total tests pass

### Phase 4: Validation

- [ ] Create `validateAnimalForm()` function
- [ ] Implement uniqueness check for subject_id
- [ ] Implement date validation with warning logic
- [ ] Implement experimenter name filtering
- [ ] Add validation summary UI
- [ ] Test all validation paths

### Phase 5: Accessibility

- [ ] Add ARIA attributes to all fields
- [ ] Implement keyboard shortcuts (Enter, Escape, Ctrl+Enter)
- [ ] Add screen reader announcements
- [ ] Test with NVDA/JAWS/VoiceOver
- [ ] Verify tab order
- [ ] Check color contrast ratios

### Phase 6: Verification

- [ ] Run full test suite (2339 + 20 = 2359 tests)
- [ ] Manual testing: create animal → navigate to workspace
- [ ] Test validation errors display correctly
- [ ] Test smart defaults from settings/last animal
- [ ] Test responsive behavior on mobile
- [ ] Use `verification-before-completion` skill

### Phase 7: Code Review & Documentation

- [ ] Request code review via `requesting-code-review` skill
- [ ] Address any P0/P1 issues from review
- [ ] Update TASKS.md with M5.5 milestone
- [ ] Update SCRATCHPAD.md with completion summary
- [ ] Create commit with conventional message

---

## Acceptance Criteria (DoD)

- ✅ Users can create animals from Home page (#/home)
- ✅ Form validates all required fields with inline errors
- ✅ Submit disabled until all fields valid
- ✅ Unique subject_id enforced (checks existing animals)
- ✅ Date of birth cannot be in future
- ✅ At least one experimenter required
- ✅ Smart defaults populate from settings/last animal
- ✅ Species uses constrained dropdown (prevents DB pollution)
- ✅ After creation, navigates to AnimalWorkspace with animal selected
- ✅ First-time users see welcome message with escape hatch
- ✅ All 20 tests passing (5 container + 15 form)
- ✅ WCAG 2.1 Level AA compliant
- ✅ Keyboard navigation works (Tab, Enter, Escape)
- ✅ Screen readers announce errors correctly
- ✅ Code review approved (no P0/P1 issues)

---

## Estimated Effort

- **Design & Review:** 2 hours (complete)
- **Test Writing (TDD):** 2-3 hours
- **Implementation:** 4-5 hours
- **Validation & Accessibility:** 1-2 hours
- **Testing & Review:** 1-2 hours

**Total:** 10-14 hours (1.5-2 days)

---

## References

### M5 Components Reused

- `/Users/edeno/Documents/GitHub/rec_to_nwb_yaml_creator/src/pages/DayEditor/DayEditor.css` (CSS variables, form styles)
- `/Users/edeno/Documents/GitHub/rec_to_nwb_yaml_creator/src/pages/DayEditor/OverviewStep.jsx` (form field patterns)
- `/Users/edeno/Documents/GitHub/rec_to_nwb_yaml_creator/src/pages/DayEditor/validation.js` (validation utilities)

### Store Integration

- `/Users/edeno/Documents/GitHub/rec_to_nwb_yaml_creator/src/state/store.js` (createAnimal action, line 160)
- `/Users/edeno/Documents/GitHub/rec_to_nwb_yaml_creator/src/state/workspaceTypes.js` (Animal type definition)

### Related Documentation

- [M5_DESIGN.md](M5_DESIGN.md) - Day Editor Stepper design
- [ANIMAL_WORKSPACE_DESIGN.md](ANIMAL_WORKSPACE_DESIGN.md) - Multi-animal architecture
- [CLAUDE.md](../CLAUDE.md) - Development guidelines
- [TASKS.md](TASKS.md) - Milestone tracking

---

## Design Revision History

- **v1.0 (2025-10-28):** Initial design from brainstorming session
- **v2.0 (2025-10-28):** Incorporated code review, UI review, UX review feedback
  - Fixed store API signature mismatch (P0-1)
  - Added uniqueness validation implementation (P0-2)
  - Fixed navigation race condition (P0-3)
  - Changed to controlled inputs (P0-4)
  - Changed species to dropdown (UX P0-4)
  - Changed experimenter names to dynamic list (UX P0-1)
  - Specified HTML5 date picker (UX P0-2)
  - Added first-time user navigation escape hatch (UX P0-3)
  - Added genotype placeholder text (UX P1-1)
  - Added validation summary UI (UX P1-4)
  - Added CSS for radio buttons, dynamic lists (UI P1.2)
  - Defined complete Home.css with responsive breakpoints (UI P1.4)
