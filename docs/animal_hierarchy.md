# Animal Hierarchy Data Model

**Status:** IMPLEMENTED (M3)
**Created:** 2025-10-28
**Purpose:** Document the workspace data model for multi-animal, multi-day management

---

## Overview

The workspace extends the single-session YAML editor with a hierarchical data model that supports:

- **Multiple Animals** - Manage multiple experimental subjects in one workspace
- **Multiple Days** - Track 30-200+ recording sessions per animal
- **Shared Metadata** - Define subject/device info once, inherit across all days
- **Configuration Versioning** - Track probe adjustments with automatic propagation

**Key Design Principle:** Each day exports as an independent YAML file identical to the legacy single-session format. The workspace is a management layer only - not a new file format.

---

## Data Hierarchy

```
Workspace
├─ animals: Record<AnimalId, Animal>
│   └─ Animal
│       ├─ subject (species, sex, genotype, DOB, weight)
│       ├─ devices (data_acq, electrode_groups, ntrodes)
│       ├─ cameras (meters_per_pixel, manufacturer, model)
│       ├─ experimenters (names, lab, institution)
│       ├─ optogenetics (optional: light sources, fibers, virus)
│       ├─ configurationHistory (probe versions)
│       └─ days: DayId[]
│
├─ days: Record<DayId, Day>
│   └─ Day
│       ├─ session (session_id, description, weight override)
│       ├─ tasks (behavioral protocol)
│       ├─ behavioral_events (DIO events)
│       ├─ associated_files (data files)
│       ├─ associated_video_files (videos)
│       ├─ technical (times_period_multiplier, raw_data_to_volts)
│       ├─ deviceOverrides (optional: per-day device changes)
│       ├─ state (draft, validated, exported)
│       └─ configurationVersion (links to Animal.configurationHistory)
│
└─ settings
    ├─ defaultLab
    ├─ defaultInstitution
    ├─ defaultExperimenters
    ├─ autoSaveInterval
    └─ shadowExportEnabled
```

---

## State Management

### Location

**File:** [src/state/store.js](../src/state/store.js)

**Implementation:** Uses React `useState` hooks within the `useStore` facade.

### State Structure

```javascript
const [workspace, setWorkspace] = useState({
  version: '1.0.0',
  lastModified: '2025-10-28T00:00:00.000Z',
  animals: {
    'remy': {
      id: 'remy',
      subject: { /* ... */ },
      devices: { /* ... */ },
      cameras: [ /* ... */ ],
      experimenters: { /* ... */ },
      days: ['remy-2023-06-22', 'remy-2023-06-23'],
      configurationHistory: [ /* ... */ ],
    },
  },
  days: {
    'remy-2023-06-22': {
      id: 'remy-2023-06-22',
      animalId: 'remy',
      date: '2023-06-22',
      session: { /* ... */ },
      tasks: [ /* ... */ ],
      /* ... */
    },
  },
  settings: { /* ... */ },
});
```

### Actions (CRUD Operations)

**Animal Actions:**
- `createAnimal(animalId, subject, metadata)` - Create new animal
- `updateAnimal(animalId, updates)` - Update animal metadata
- `deleteAnimal(animalId)` - Delete animal and all its days
- `addConfigurationSnapshot(animalId, config)` - Add probe configuration version

**Day Actions:**
- `createDay(animalId, date, session)` - Create new recording day
- `updateDay(dayId, updates)` - Update day metadata
- `deleteDay(dayId)` - Delete recording day

**Settings Actions:**
- `updateWorkspaceSettings(settings)` - Update workspace defaults

### Selectors

**Legacy Selectors (unchanged):**
- `getCameraIds()` - Get camera IDs from formData
- `getTaskEpochs()` - Get task epochs from formData
- `getDioEvents()` - Get behavioral event names from formData

**New Workspace Selectors:**
- `getAnimalDays(animalId)` - Get all days for an animal, sorted by date

---

## YAML Export Flow

### Inheritance Model

Each day's YAML is generated by merging:

1. **Animal defaults** → subject, devices, cameras, experimenters
2. **Configuration version** → electrode groups from specific probe config
3. **Day specifics** → session, tasks, epochs, files
4. **Day overrides** → weight, experiment_description, device overrides

### Export Function

**Location:** [src/state/workspaceUtils.js](../src/state/workspaceUtils.js)

**Function:** `mergeDayMetadata(animal, day)`

**Example:**

```javascript
import { mergeDayMetadata } from './state/workspaceUtils';
import { encodeYaml } from './io/yaml';

// Get data
const animal = workspace.animals['remy'];
const day = workspace.days['remy-2023-06-22'];

// Merge
const metadata = mergeDayMetadata(animal, day);

// Export
const yaml = encodeYaml(metadata);
const filename = `06222023_remy_metadata.yml`;
downloadYamlFile(filename, yaml);
```

### Metadata Merging Rules

| Field | Source | Override Rule |
|-------|--------|---------------|
| `experimenter_name` | Animal.experimenters | No override |
| `lab` | Animal.experimenters | No override |
| `institution` | Animal.experimenters | No override |
| `subject.*` | Animal.subject | `weight` can be overridden by Day |
| `experiment_description` | Day.session | Default to '' if not set |
| `session_description` | Day.session | Always from Day |
| `session_id` | Day.session | Always from Day |
| `cameras` | Animal.cameras | Can be overridden by Day.deviceOverrides |
| `electrode_groups` | Configuration version | Can be overridden by Day.deviceOverrides |
| `ntrode_electrode_group_channel_map` | Configuration version | Can be overridden by Day.deviceOverrides |
| `tasks` | Day.tasks | Always from Day |
| `behavioral_events` | Day.behavioral_events | Always from Day |
| `times_period_multiplier` | Day.technical | Always from Day |
| `raw_data_to_volts` | Day.technical | Always from Day |
| Optogenetics fields | Animal.optogenetics | Only included if Animal has optogenetics |

---

## Configuration Versioning

### Problem

Probe positions change during chronic experiments (e.g., lowering tetrodes to reach deeper layers). These changes affect multiple days forward.

### Solution

**Configuration History:** Each Animal maintains an array of configuration snapshots with version numbers.

**Example:**

```javascript
animal.configurationHistory = [
  {
    version: 1,
    date: '2023-06-01',
    description: 'Initial implant',
    devices: {
      electrode_groups: [ /* 8 tetrodes at initial depth */ ],
      ntrode_electrode_group_channel_map: [ /* channel maps */ ],
    },
    appliedToDays: ['remy-2023-06-01', ..., 'remy-2023-06-14'],
  },
  {
    version: 2,
    date: '2023-06-15',
    description: 'Lowered CA1 tetrodes by 40um',
    devices: {
      electrode_groups: [ /* 8 tetrodes at new depth */ ],
      ntrode_electrode_group_channel_map: [ /* same channel maps */ ],
    },
    appliedToDays: ['remy-2023-06-15', ..., 'remy-2023-07-30'],
  },
];
```

### Day Configuration Reference

Each Day has a `configurationVersion` field that links to the appropriate configuration:

```javascript
day.configurationVersion = 2; // Uses second configuration
```

When exporting YAML, `mergeDayMetadata()` selects the correct configuration:

```javascript
const config = animal.configurationHistory.find(
  c => c.version === day.configurationVersion
) || animal.configurationHistory[0];

merged.electrode_groups = config.devices.electrode_groups;
```

---

## Storage Strategy

### Phase 1: localStorage (Current)

**Implementation:** M9 (Autosave)

**Capacity:** ~5MB (supports ~90 days × 10 animals)

**Pros:**
- No backend required
- Instant save/load
- Works offline
- Browser-native

**Cons:**
- Browser-specific (not shareable)
- Cleared on cache wipe
- Size limit (~5-10 MB)

**Mitigation:**
- Export workspace → JSON backup
- Import workspace → Restore from JSON
- Warning when approaching limit

### Phase 2: File System (Future)

**Implementation:** Post-M12 (Electron)

**Benefits:**
- Unlimited storage
- Shareable via network drives
- Direct integration with data directories

**Complexity:**
- Requires Electron desktop app
- File sync conflicts
- OS-specific file watching

---

## Backward Compatibility

### Legacy Mode

The workspace is FULLY backward compatible with existing code:

**Legacy Access (unchanged):**

```javascript
const { model, actions } = useStore();

// Access form data directly (legacy mode)
const sessionId = model.session_id;
const cameras = model.cameras;

// Update form data (legacy mode)
actions.updateFormData('session_id', 'new_value');
actions.addArrayItem('cameras', 1);
```

**Workspace Access (new in M3):**

```javascript
const { model, actions } = useStore();

// Access workspace (new mode)
const animals = model.workspace.animals;
const days = model.workspace.days;

// Workspace actions (new mode)
actions.createAnimal('remy', { species: 'Rattus norvegicus', ... });
actions.createDay('remy', '2023-06-22', { session_id: '...', ... });
```

### Model Structure

```javascript
{
  model: {
    // Legacy form fields (unchanged)
    session_id: 'experiment_001',
    experimenter_name: ['Guidera, Jennifer'],
    cameras: [ /* ... */ ],
    tasks: [ /* ... */ ],
    // ... all existing fields

    // New workspace field (M3+)
    workspace: {
      animals: { /* ... */ },
      days: { /* ... */ },
      settings: { /* ... */ },
    },
  },
}
```

---

## Testing Strategy

### Test Coverage

**Total:** 57 tests across 3 test files

**Files:**
1. [workspace-animal.test.js](../src/__tests__/unit/state/workspace-animal.test.js) - 15 tests
   - Create animal with minimal/full metadata
   - Update animal subject/experimenters
   - Delete animal (cascades to days)
   - Configuration history versioning

2. [workspace-day.test.js](../src/__tests__/unit/state/workspace-day.test.js) - 20 tests
   - Create day with minimal/full metadata
   - Update day session/tasks/state
   - Delete day (removes from animal)
   - Selectors (getAnimalDays sorted by date)

3. [workspace-merge.test.js](../src/__tests__/unit/state/workspace-merge.test.js) - 22 tests
   - Basic merging (animal + day → complete metadata)
   - Inheritance rules (animal defaults propagate)
   - Overrides (day weight, cameras, electrode groups)
   - Configuration versioning (correct version selected)
   - Optogenetics (conditional inclusion)
   - YAML parity (matches legacy exporter structure)

### Test Philosophy

**TDD (Test-Driven Development):**
1. Write test FIRST (defines expected behavior)
2. Run test, verify it FAILS (RED phase)
3. Implement code to make test pass (GREEN phase)
4. Refactor for clarity (REFACTOR phase)

**Example from M3:**

```javascript
// 1. Write test first (RED)
it('creates animal with minimal required fields', () => {
  const { result } = renderHook(() => useStore());

  act(() => {
    result.current.actions.createAnimal('remy', {
      species: 'Rattus norvegicus',
      sex: 'M',
      // ...
    });
  });

  expect(result.current.model.workspace.animals['remy']).toBeDefined();
  // ... more assertions
});

// 2. Implement createAnimal() action (GREEN)
createAnimal: (animalId, subject, metadata) => {
  setWorkspace(prev => ({
    ...prev,
    animals: {
      ...prev.animals,
      [animalId]: { /* create animal */ },
    },
  }));
},
```

---

## Migration Path

### Phase 1: Single Animal (M3-M8) ✅ M3 COMPLETE

**Scope:** Prove multi-day workflow with one animal

**Features (M3 implemented):**
- ✅ Create animal
- ✅ Add/edit/delete days
- ✅ Configuration versioning
- ✅ Merge animal + day → YAML

**Features (M4-M8 planned):**
- Batch day creation
- Validation summary
- Single-day export
- Batch export

**Simplifications:**
- No animal switcher (assume one active animal)
- No UI for probe reconfiguration wizard
- No import from existing YAMLs

### Phase 2: Multi-Animal (M9-M10)

**Scope:** Full workspace management

**Features:**
- Workspace home (animal selection)
- Create/import multiple animals
- Animal switcher in navigation
- Probe reconfiguration wizard
- Import from existing YAML files
- Export workspace as JSON backup

### Phase 3: Advanced Features (Post-M12)

**Scope:** Power user features

**Features:**
- File system integration (Electron)
- Templates (reusable task protocols)
- Experiment groups (multi-animal studies)
- Analytics (days per animal, validation trends)
- Cloud sync (optional backend)

---

## References

- **Design Document:** [ANIMAL_WORKSPACE_DESIGN.md](ANIMAL_WORKSPACE_DESIGN.md)
- **Refactoring Plan:** [REFACTORING_PLAN_REVISED.md](REFACTORING_PLAN_REVISED.md)
- **Implementation:** [src/state/store.js](../src/state/store.js)
- **Utilities:** [src/state/workspaceUtils.js](../src/state/workspaceUtils.js)
- **Type Definitions:** [src/state/workspaceTypes.js](../src/state/workspaceTypes.js)
- **Tests:** [src/__tests__/unit/state/workspace-*.test.js](../src/__tests__/unit/state/)

---

## Summary

The animal hierarchy data model provides a scalable foundation for multi-animal, multi-day experiments while maintaining 100% backward compatibility with the legacy single-session workflow. The implementation follows TDD principles with comprehensive test coverage (57 tests) and preserves the critical YAML export format required by trodes_to_nwb and Spyglass.

**Key Achievements (M3):**
- ✅ 57 new tests, all passing
- ✅ Zero regressions (2275 total tests passing)
- ✅ YAML export parity verified
- ✅ Backward compatible model structure
- ✅ Configuration versioning for probe tracking
